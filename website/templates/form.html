{% extends "base.html" %}

{% block title %}Create Fundraiser{% endblock %}

{% block content %}
<div class="bg-gradient-to-br from-red-50 to-pink-50 py-8">
  <div class="max-w-4xl mx-auto px-4">
    <div class="bg-white rounded-2xl shadow-xl overflow-hidden">

      <!-- Header -->
      <div class="bg-gradient-to-r from-red-700 to-red-800 px-8 py-6">
        <h1 class="text-3xl font-bold text-white flex items-center gap-3">
          <svg class="lucide lucide-heart w-8 h-8 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-width="2"><use href="#heart" /></svg>
          Create Your Fundraiser
        </h1>
        <p class="text-red-100 mt-2">Share your story and raise funds for what matters most</p>
      </div>

      <!-- Form -->
      <form id="fundraiserForm" class="space-y-10 p-8">

        <!-- Basic Info Section -->
        <section class="space-y-6">
          <h2 class="text-2xl font-semibold text-gray-800">Basic Information</h2>
          <label>Fundraiser Title *</label>
          <input type="text" name="title" required placeholder="e.g., Help for Jane's Surgery" class="w-full px-4 py-3 border rounded-lg" />

          <label>Category *</label>
          <select name="category" required class="w-full px-4 py-3 border rounded-lg">
            <option value="">Select a category</option>
            <option>Racism</option>
            <option>Sexism</option>
            <option>Ageism</option>
            <option>Religious Discrimination</option>
            <option>Ableism</option>
            <option>Linguistic Discrimination</option>
            <option>LGBTQ Discrimination</option>
            <option>Mental Health Stigmatization</option>
            <option>Classism</option>
          </select>

          <label>Fundraising Goal *</label>
          <input type="number" name="goal" min="0" required placeholder="e.g., 5000" class="w-full px-4 py-3 border rounded-lg" />

          <label>Location</label>
          <input type="text" name="location" placeholder="Region, California" class="w-full px-4 py-3 border rounded-lg" />

          <label>Beneficiary (if not yourself)</label>
          <input type="text" name="beneficiary" placeholder="e.g., Jane Doe" class="w-full px-4 py-3 border rounded-lg" />
        </section>

        <!-- Personal Details -->
        <section class="space-y-6">
          <h2 class="text-2xl font-semibold text-gray-800">Personal Details (Optional)</h2>
          <label>Gender Identity</label>
          <input type="text" name="gender" placeholder="e.g., Non-binary" class="w-full px-4 py-3 border rounded-lg" />

          <label>Race/Ethnicity</label>
          <input type="text" name="race" placeholder="e.g., Black or African American" class="w-full px-4 py-3 border rounded-lg" />

          <label>Sexual Orientation</label>
          <input type="text" name="sexualOrientation" placeholder="e.g., Lesbian" class="w-full px-4 py-3 border rounded-lg" />

          <label>Disabilities or Accessibility Needs</label>
          <textarea name="disabilities" rows="3" class="w-full px-4 py-3 border rounded-lg"></textarea>

          <label>Other Relevant Information</label>
          <textarea name="otherInfo" rows="3" class="w-full px-4 py-3 border rounded-lg"></textarea>
        </section>

        <!-- Wishlist -->
        <section class="space-y-6">
          <h2 class="text-2xl font-semibold text-gray-800">Wishlist</h2>
          <div id="wishlistContainer"></div>
          <button type="button" id="addItemBtn" class="w-full border-2 border-dashed border-red-700 rounded-lg p-4 text-red-700">Add Item</button>
        </section>

        <!-- Media Upload -->
        <section class="space-y-6">
          <h2 class="text-2xl font-semibold text-gray-800">Photos & Media</h2>
          <input type="file" id="mediaInput" accept="image/*" multiple class="w-full" />
          <div id="mediaPreview" class="grid grid-cols-2 gap-4 mt-2"></div>
        </section>

        <!-- Story -->
        <section class="space-y-6">
          <h2 class="text-2xl font-semibold text-gray-800">Tell Your Story</h2>
          <textarea name="story" rows="6" class="w-full px-4 py-3 border rounded-lg"></textarea>
        </section>

        <!-- Organizer Info -->
        <section class="space-y-6">
          <h2 class="text-2xl font-semibold text-gray-800">Organizer Information</h2>
          <label>Your Name *</label>
          <input type="text" name="organizerName" required class="w-full px-4 py-3 border rounded-lg" />

          <label>Email *</label>
          <input type="email" name="organizerEmail" required class="w-full px-4 py-3 border rounded-lg" />

          <label>Phone</label>
          <input type="tel" name="organizerPhone" class="w-full px-4 py-3 border rounded-lg" />

          <label>Relationship to Beneficiary *</label>
          <input type="text" name="relationship" required class="w-full px-4 py-3 border rounded-lg" />
        </section>

        <!-- PayPal Info -->
        <section class="space-y-6">
          <h2 class="text-2xl font-semibold text-gray-800">PayPal Information</h2>
          <label>PayPal Email</label>
          <input type="email" name="paypal" placeholder="your-paypal@example.com" class="w-full px-4 py-3 border rounded-lg" />
        </section>

        <!-- Submit -->
        <div class="flex gap-4 pt-6">
          <button type="submit" class="flex-1 bg-red-700 hover:bg-red-800 text-white font-semibold py-4 px-8 rounded-lg">Create Fundraiser</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Scripts -->
<script src="https://cdn.emailjs.com/dist/email.min.js"></script>
<script>
  // Initialize EmailJS with your public key
  emailjs.init("2n-AqRl-QVwJJIdEF"); // <-- Replace with your EmailJS public key

  const form = document.getElementById("fundraiserForm");

  form.addEventListener("submit", function(e) {
    e.preventDefault();

    // Collect wishlist items
    const wishlistItems = [];
    document.querySelectorAll("#wishlistContainer .wishlist-item").forEach(item => {
      wishlistItems.push({
        name: item.querySelector('input[name="item[]"]').value,
        description: item.querySelector('input[name="description[]"]').value,
        cost: item.querySelector('input[name="cost[]"]').value
      });
    });

    // Collect media files as Base64
    const mediaInput = document.getElementById("mediaInput");
    const mediaFiles = [];

    const sendEmail = () => {
      const templateParams = {
        title: form.title.value,
        category: form.category.value,
        goal: form.goal.value,
        location: form.location.value,
        beneficiary: form.beneficiary.value,
        gender: form.gender.value,
        race: form.race.value,
        sexualOrientation: form.sexualOrientation.value,
        disabilities: form.disabilities.value,
        otherInfo: form.otherInfo.value,
        story: form.story.value,
        organizerName: form.organizerName.value,
        organizerEmail: form.organizerEmail.value,
        organizerPhone: form.organizerPhone.value,
        relationship: form.relationship.value,
        paypalEmail: form.paypal.value,
        wishlistItems: wishlistItems,
        mediaFiles: mediaFiles
      };

      // Send email using your service ID & template ID
      emailjs.send("service_qtgowmv", "template_9vqmpl9", templateParams)
        .then(() => {
          alert("Fundraiser submitted! Check your email.");
          form.reset();
          document.getElementById("wishlistContainer").innerHTML = "";
          document.getElementById("mediaPreview").innerHTML = "";
        })
        .catch(err => {
          console.error("Email failed:", err);
          alert("Failed to send fundraiser email. See console.");
        });
    };

    if (mediaInput.files.length > 0) {
      const readers = Array.from(mediaInput.files).map(file => {
        return new Promise(resolve => {
          const reader = new FileReader();
          reader.onload = e => resolve(e.target.result);
          reader.readAsDataURL(file);
        });
      });

      Promise.all(readers).then(results => {
        results.forEach(dataURL => mediaFiles.push(dataURL));
        sendEmail();
      });
    } else {
      sendEmail();
    }
  });

  // Wishlist functionality
  document.addEventListener('DOMContentLoaded', () => {
    const container = document.getElementById('wishlistContainer');
    const addBtn = document.getElementById('addItemBtn');

    addBtn.addEventListener('click', () => {
      const newItem = document.createElement('div');
      newItem.classList.add('wishlist-item', 'mb-6', 'pb-4', 'border-b');

      newItem.innerHTML = `
        <input type="text" name="item[]" placeholder="Item Name" required class="w-full px-4 py-2 border rounded mb-2" />
        <input type="text" name="description[]" placeholder="Description" class="w-full px-4 py-2 border rounded mb-2" />
        <input type="number" name="cost[]" placeholder="Estimated Cost" min="0" class="w-full px-4 py-2 border rounded mb-2" />
        <button type="button" class="remove-btn text-red-600 hover:text-red-800">Remove</button>
      `;

      newItem.querySelector('.remove-btn').addEventListener('click', () => newItem.remove());
      container.appendChild(newItem);
    });
  });
</script>
{% endblock %}
